#!/bin/bash
# Centralized Isaac Robot Management Command
# Unified interface for managing robot nodes, graphs, and services

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
UTILS_DIR="${SCRIPT_DIR}/../utils"
ISAAC_ROOT="${ISAAC_ROOT:-$(python3 "${UTILS_DIR}/find_isaac_root.py" 2>/dev/null || echo "/opt/isaac-robot")}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m'

# Get current graph selection
get_selected_graph() {
    "${UTILS_DIR}/get_graph.sh" 2>/dev/null || echo "minimal"
}

# Source ROS 2 if available
source_ros2() {
    if [ -f "/opt/ros/humble/setup.bash" ]; then
        source /opt/ros/humble/setup.bash
    fi
    if [ -f ~/ros2_ws/install/setup.bash ]; then
        source ~/ros2_ws/install/setup.bash
    fi
}

usage() {
    cat << EOF
Isaac Robot Management

Usage: isaac <command> [options]

Commands:
  start              Start nodes with selected graph
  stop               Stop all nodes
  restart            Restart nodes with selected graph
  status             Show system status
  graph              Show or select graph
  graph <name>       Switch to graph and restart
  switch <name>      Switch graph (minimal|full|robot)
  logs               Show node logs
  service            Manage systemd service
    service start    Start systemd service
    service stop     Stop systemd service
    service restart  Restart systemd service
    service enable   Enable service (start on boot)
    service disable  Disable service
    service status   Show service status

Graph Options:
  minimal  - Essential nodes only (system monitor)
  full     - Complete system with all components
  robot    - Configurable graph with custom settings

Examples:
  isaac start                    # Start with selected graph
  isaac graph                    # Show current graph
  isaac switch full              # Switch to full graph
  isaac graph robot              # Switch to robot graph and restart
  isaac restart                  # Restart with current graph
  isaac service enable           # Enable auto-start on boot
  isaac status                   # Show system status

EOF
}

cmd_start() {
    local graph="${1:-$(get_selected_graph)}"

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Starting Isaac Robot${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo "Graph: $graph"
    echo ""

    # Check if already running
    if systemctl is-active --quiet isaac-robot.service 2>/dev/null; then
        echo -e "${YELLOW}Service is already running. Use 'isaac restart' to restart.${NC}"
        return 0
    fi

    # Start via service if enabled, otherwise direct launch
    if systemctl is-enabled --quiet isaac-robot.service 2>/dev/null; then
        echo "Starting via systemd service..."
        sudo systemctl start isaac-robot.service
    else
        echo "Starting directly..."
        cd "$ISAAC_ROOT"
        ROBOT_GRAPH="$graph" "$ISAAC_ROOT/scripts/system/start_robot.sh"
    fi
}

cmd_stop() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Stopping Isaac Robot${NC}"
    echo -e "${BLUE}========================================${NC}"

    # Stop via systemd if running as service
    if systemctl is-active --quiet isaac-robot.service 2>/dev/null; then
        echo "Stopping systemd service..."
        sudo systemctl stop isaac-robot.service
    fi

    # Stop any direct launches
    pkill -f "start_robot.sh" || true
    pkill -f "ros2 launch.*graph.launch.py" || true

    echo -e "${GREEN}✓ Stopped${NC}"
}

cmd_restart() {
    local graph="${1:-$(get_selected_graph)}"

    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Restarting Isaac Robot${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo "Graph: $graph"
    echo ""

    cmd_stop
    sleep 2
    cmd_start "$graph"
}

cmd_status() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}Isaac Robot Status${NC}"
    echo -e "${BLUE}========================================${NC}"
    echo ""

    # Show selected graph
    local current_graph=$(get_selected_graph)
    echo -e "${GREEN}Selected Graph:${NC} $current_graph"
    echo ""

    # Check systemd service
    if systemctl list-unit-files | grep -q isaac-robot.service; then
        echo -e "${GREEN}Systemd Service:${NC}"
        if systemctl is-enabled --quiet isaac-robot.service 2>/dev/null; then
            echo "  Status: $(systemctl is-active isaac-robot.service 2>/dev/null || echo 'inactive')"
            echo "  Enabled: yes (starts on boot)"
        else
            echo "  Status: $(systemctl is-active isaac-robot.service 2>/dev/null || echo 'inactive')"
            echo "  Enabled: no"
        fi
        echo ""
    fi

    # Show ROS 2 nodes
    source_ros2
    if ros2 node list &>/dev/null 2>&1; then
        echo -e "${GREEN}Running Nodes:${NC}"
        ros2 node list | sed 's/^/  /'
        echo ""

        echo -e "${GREEN}Active Topics:${NC}"
        local topic_count=$(ros2 topic list 2>/dev/null | wc -l)
        if [ "$topic_count" -gt 0 ]; then
            ros2 topic list 2>/dev/null | head -10 | sed 's/^/  /'
            if [ "$topic_count" -gt 10 ]; then
                echo "  ... ($topic_count total)"
            fi
        else
            echo "  No topics"
        fi
    else
        echo -e "${YELLOW}No ROS 2 nodes running${NC}"
    fi
}

cmd_graph() {
    local graph="${1:-}"

    if [ -z "$graph" ]; then
        # Show current graph
        local current=$(get_selected_graph)
        echo -e "${GREEN}Current Graph:${NC} $current"
        echo ""
        echo "Available graphs:"
        echo "  minimal     - Essential nodes only"
        echo "  full        - Complete system"
        echo "  robot       - Configurable graph"
        echo "  bench_test  - Cameras + visualization (for testing)"
        echo ""
        echo "To switch: isaac switch <graph>"
        echo "To switch and restart: isaac graph <graph>"
    else
        # Switch graph and restart
        cmd_switch "$graph"
        cmd_restart "$graph"
    fi
}

cmd_switch() {
    local graph="${1:-}"

    if [ -z "$graph" ]; then
        echo "Error: Graph name required"
        echo "Usage: isaac switch <minimal|full|robot>"
        exit 1
    fi

    # Validate graph
    case "$graph" in
        minimal|full|robot|bench_test)
            ;;
        *)
            echo -e "${RED}Error: Invalid graph '$graph'${NC}"
            echo "Valid options: minimal, full, robot, bench_test"
            exit 1
            ;;
    esac

    echo -e "${BLUE}Switching to graph: $graph${NC}"
    "${UTILS_DIR}/select_graph.sh" "$graph"

    # Update systemd service override if it exists
    if systemctl list-unit-files | grep -q isaac-robot.service; then
        echo "Updating systemd service configuration..."
        # Create override directory
        sudo mkdir -p /etc/systemd/system/isaac-robot.service.d/

        # Create override file with graph selection
        sudo tee /etc/systemd/system/isaac-robot.service.d/graph-override.conf > /dev/null << EOF
[Service]
Environment="ROBOT_GRAPH=$graph"
EOF
        sudo systemctl daemon-reload
        echo -e "${GREEN}✓ Graph switched to: $graph${NC}"
        echo "Service will use new graph on next start/restart"
    else
        echo -e "${GREEN}✓ Graph switched to: $graph${NC}"
    fi
}

cmd_logs() {
    if systemctl is-active --quiet isaac-robot.service 2>/dev/null; then
        sudo journalctl -u isaac-robot.service -f --no-pager
    else
        echo "Service not running. Showing recent logs:"
        sudo journalctl -u isaac-robot.service -n 50 --no-pager || echo "No logs available"
    fi
}

cmd_service() {
    local action="${1:-status}"

    case "$action" in
        start)
            sudo systemctl start isaac-robot.service
            echo -e "${GREEN}✓ Service started${NC}"
            ;;
        stop)
            sudo systemctl stop isaac-robot.service
            echo -e "${GREEN}✓ Service stopped${NC}"
            ;;
        restart)
            sudo systemctl restart isaac-robot.service
            echo -e "${GREEN}✓ Service restarted${NC}"
            ;;
        enable)
            sudo systemctl enable isaac-robot.service
            echo -e "${GREEN}✓ Service enabled (will start on boot)${NC}"
            ;;
        disable)
            sudo systemctl disable isaac-robot.service
            echo -e "${GREEN}✓ Service disabled${NC}"
            ;;
        status)
            systemctl status isaac-robot.service --no-pager -l || true
            ;;
        *)
            echo "Unknown service action: $action"
            echo "Valid actions: start, stop, restart, enable, disable, status"
            exit 1
            ;;
    esac
}

# Main command dispatch
case "${1:-}" in
    start)
        cmd_start "${2:-}"
        ;;
    stop)
        cmd_stop
        ;;
    restart)
        cmd_restart "${2:-}"
        ;;
    status)
        cmd_status
        ;;
    graph)
        cmd_graph "${2:-}"
        ;;
    switch)
        cmd_switch "${2:-}"
        ;;
    logs)
        cmd_logs
        ;;
    service)
        cmd_service "${2:-status}"
        ;;
    *)
        usage
        exit 1
        ;;
esac
